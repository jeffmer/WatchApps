var correlator=function(){var a=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAt6fBHKk19RAAg1fgAgAcmqPEHAYZGb/AATAApC0ZCRti/AfGAA0/wWwkAJK8Yl/gEoO8YP3nH6woHAvEBChtKCuoCAgAqA/EBChhLuL8C8f8yCuoDA7y/YvB/AgEyACu+vwPx/zNj8H8DATO58QEJB/sHRNrRZEW8vzBGpEYBNqZFuL+mRiUuAfH/McXRCUt7RMP4hMDD+IjgKLEoI1hDTvZgI5P78PC96PCHfwAAgGr////g/v//Akt7RNP4hABwRwC/tv7//wJLe0TT+IgAcEcAv6b+//8JSXlEC2jKGBBxWhwFSxNAACu+vwPx/zNj8H8DATMLYHBHAL9/AACAlv7//w==");
return{put:E.nativeCall(357,"void(int)",a),Cmax:E.nativeCall(341,"int(void)",a),Cmin:E.nativeCall(325,"int(void)",a),bpm:E.nativeCall(141,"int(void)",a)}}(),avgMedFilter=function(){var a=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcSnpEMLUTaALrgwEBM0hgByGT+/HxwevBAVsaibATYAGoACMRHVH4IxBA+CMQATMHK/fRaUYAIgEyUfgEXxNGBysL0Qcq99EEmwOYGEQFmwNEAyCT+/DwCbAwvVD4I0ClQsG/DWhA+CNQDGAlRgEz5ucAv9r///8=");return{filter:E.nativeCall(33,"int(int)",a)}}(),medianFilter=function(){var a=atob("BQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAACFJeUT4tQtomgAKMiLwBwIAr63rAg1KaAHrggUBMqhgkvvz8AP7ECIYSEpgbEYAInhEmkIH2gDxCAFR+CIQRPgiEAEy9ecSSnpEACHS+CTAIh9hRRPcUvgEbwExFUYIRphC9tpV+ATvdkXEvxZoLmAA8QEAxL/C+ADgdkbw51T4LAC9Rvi9AL/S////pP///4z///8=");
return{filter:E.nativeCall(41,"int(int)",a)}}(),lpfFilter=function(){var a=atob("AAAAAAAAAACBeO09gXhtPoF47T0dwDi/dfE9PhNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,"int(int)",a)}}(),hpfFilter=function(){var a=atob("AAAAAAAAAAAAzl4/AM7evwDOXj+xpNy/mO5BPxNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,
"int(int)",a)}}(),agcFilter=function(){var a=atob("AACgQcjSgz91k3g/AAAAQIDq4HIeS6Lr4HIH7hAqe0S47sd60+0AerTu53rx7hD6zL+T7QF6k+0CehZLZ+6HegfuEAp7RPjux2qT7QN6w+0Aeifuh2r07sZq8e4Q+hXcJ+5nevTux2rx7hD6DtRkI0NDB+4QOnfup3r47sdqhu6nev3ux3oX7pAKcEcAIHBH3v///7j///8=");return{filter:E.nativeCall(17,"int(int)",a)}}(),pulseDetector=function(){var a=atob("AAAAAAAAAAAUAAAA7P///xZKekQTeOuxU2iDQgHakGAe4B3d0WiTaFsaFTtA9qIxi0JP8AABjL8AIwEj0WARcAtKekRRaIhCC90AIZFgASERcAbgU2iYQgDa0GAAI+/nACMESnpEUGAYRnBH6v///7r///+Y////");
return{isBeat:E.nativeCall(17,"int(int)",a)}}(),HRS={writeByte:function(a,c){P8I2C.writeTo(68,a,c)},readByte:function(a){P8I2C.writeTo(68,a);return P8I2C.readFrom(68,1)[0]},enable:function(){HRS.writeByte(23,16);HRS.writeByte(22,120);HRS.writeByte(1,224);HRS.writeByte(12,110)},disable:function(){HRS.writeByte(1,8);HRS.writeByte(2,128);HRS.writeByte(12,78);HRS.writeByte(22,136);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2);
HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2)},read:function(){var a=HRS.readByte(9),c=HRS.readByte(10),b=HRS.readByte(15);return a<<8|(c&15)<<4|b&15}};P8.setLCDTimeout(300);var x=0,lasty=239,lastPeak=0,interval,bpminterval,f1=hpfFilter.filter,f2=medianFilter.filter,f3=agcFilter.filter,f4=lpfFilter.filter,bf=avgMedFilter.filter,det=pulseDetector.isBeat,put=correlator.put;
function doread(){var a=f4(f3(f2(f1(HRS.read()))));a=139-a;a=239<a?239:40>a?40:a;put(a);if(det(a)){var c=Date.now(),b=Math.floor(6E4/(c-lastPeak));0<b&&200>b&&(b=bf(b),g.setColor(-1),g.drawString("BPM: "+b+" ",120,0,!0));lastPeak=c}g.setColor(0);g.fillRect(x,40,x+1,239);g.setColor(2016);g.fillRect(x,lasty,x+1,a);lasty=a;x+=2;240<=x&&(x=0)}function showBPM(){var a=correlator.bpm();g.setColor(65504).drawString("BPM: "+a+" ",10,0,!0)}
function startMeasure(){interval||(g.clear(),g.reset(),g.setFont("6x8",2),g.drawString("BPM: -- ",120,0,!0),x=0,HRS.enable(),interval=setInterval(doread,40),bpminterval=setInterval(showBPM,2E3))}function stopMeasure(){interval&&(interval=clearInterval(interval),bpminterval&&(bpminterval=clearInterval(bpminterval)),HRS.disable(),g.setColor(64832).drawString("PAUSED",120,20,!0))}TC.on("swipe",function(a){a==TC.RIGHT?startMeasure():a==TC.LEFT&&stopMeasure()});E.on("kill",function(){stopMeasure()});
setTimeout(function(){E.showMessage("Swipe right\n to start.\n Swipe left\n to stop.","Heart Rate")},500);